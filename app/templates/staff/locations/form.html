{% extends "../base.html" %}

{% block sidebar %}
{% with page=2 %}
{{ block.super }}
{% endwith %}
{% endblock %}

{% block content %}
<div class="content p-3">  
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Location Details</h6>
    </div>
    <div class="card-body">      
      <form method="POST" novalidate> 
        {% csrf_token %}
        <table class="table table-form mb-2">
          <tr>
            <td colspan="2"><a href='javascript:openSearchAddressModal()' class="btn btn-primary float-right"><i class="fa fa-search"></i></a></td>
          </tr>
          {{ form }}
        </table>
    
        <a class="btn btn-sm btn-secondary mr-1" href='/staff/locations'>
          <i class="fas fa-arrow-left text-white-50"></i> Back
        </a>
        
        <button class="btn btn-sm btn-primary" type="submit">
          <i class="fas fa-save text-white-50"></i> Save
        </button>
      </form>
    </div>
  </div>

  <div class="modal fade" id="searchAddressModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Search for Addresses</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="card shadow mb-4">
            <div class="card-body" >
              <input id="keyword" class="form-control" placeholder="Enter a phrase to search"
                onkeydown="if(event.key == 'Enter') searchAddress();">
              <div id="spinner" class="mt-3 text-center" style="width: 100%;display: none;">
                <div class="spinner-border"></div>
              </div>
              <div id="searchResult"></div>              
            </div>
          </div>
          <span style="color:red" id="error"></span>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-primary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="locationModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Choose Location</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div id="map" style="width: 100%; height: 500px;"></div>
        </div>       
      </div>
    </div>
  </div>
</div>

<script>
var map;
var marker;
var ref_position = { lat: 52.479865, lng: -1.911067 };

function getPosition() {  
  var geoLocation = $('#id_geoLocation').val();

  if(geoLocation && geoLocation.indexOf(',') >0) {
    var arr = geoLocation.split(',');
    return { lat: parseFloat(arr[0]), lng: parseFloat(arr[1]) };
  }

  return null;
}

function setMarker(position, update) {  
  if(marker) {
    marker.setMap(null);
  }
  marker = new google.maps.Marker({ position: position, map: map });
  if(update) map.setCenter(position);
}

function initMapEvent() {
  google.maps.event.addListener(map, 'click', function(e) {
      var position = e.latLng;
      var lat = position.lat().toFixed(6);
      var lng = position.lng().toFixed(6);
      $('#id_geoLocation').val(`${lat},${lng}`);
      setMarker(position);
      setTimeout(() => $('#locationModal').modal('hide'), 500);
  });
}

function initMap() {  
  var position = getPosition();
  if(position) {
    map = new google.maps.Map(document.getElementById('map'), { zoom: 16, center: position });
    setMarker(position);
    initMapEvent();
  }else {
    map = new google.maps.Map(document.getElementById('map'), { zoom: 16, center: ref_position });
    initMapEvent();
    
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(x => {
        map.setCenter({lat: x.coords.latitude, lng: x.coords.longitude});
      });
    }
  }  
}

function openLocationModal() {
  $('#locationModal').modal();
}

$('#locationModal').on('shown.bs.modal', function() {
  setMarker(getPosition(), true);
});

function openSearchAddressModal(id) {
  $("#keyword").val('');
  $('#error').html('');
  $('#searchResult').html('');
  $("#searchAddressModal").modal();
}

function createAddressTable(items) {
  return (
   `<table class="table mt-3">
      <thead>
        <tr>
          <th style="width:30%">Address Line 1</th>
          <th style="width:30%">Address Line 2</th>
          <th style="width:15%">City</th>
          <th style="width:15%">Post Code</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody>` +
        items.map((item,i) => 
          (
            `<tr>
              <td><span id="addressLine1_${i}">${item.addressLine1}</span></td>
              <td><span id="addressLine2_${i}">${item.addressLine2}</span></td>
              <td><span id="city_${i}">${item.city}</span></td>
              <td><span id="postCode_${i}">${item.postCode}</span></td>
              <td class="text-center"><button onclick="selectAddress(${i})" class="btn btn-sm btn-primary">Select</button></td>
            </tr>`
          )
        ).join('') +
        (items.length == 0 ? 
          `<tr>
            <td colspan="5">No result found</td>
          </tr>`: ''
        ) +
      `</tbody>
    </table>`
  );
}

async function searchAddress() {
  var keyword = $('#keyword').val();
  if(keyword == '') return;

  $('#error').html('');
  $('#searchResult').html('');
  $('#spinner').show();  
  var resp = await fetch("/api/locations/search_by_postcode?q=" + keyword);
  var result = await resp.json();

  if(!result.success) {
    $('#spinner').hide();
    $('#error').html("Error: " + result.error);
    return;
  }  

  var html = createAddressTable(result.items);  
  $('#spinner').hide();
  $('#searchResult').html(html);
}

function selectAddress(i) {  
  $("#searchAddressModal").modal('hide');
  $("#id_addressLine1").val($(`#addressLine1_${i}`).html());
  $("#id_addressLine2").val($(`#addressLine2_${i}`).html());
  $("#id_city").val($(`#city_${i}`).html());
  $("#id_postCode").val($(`#postCode_${i}`).html());
}

$(document).ready(function(){
  $('#id_geoLocation').click(function(){
    openLocationModal();
  });
});


</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBR8gU4Te36NCYlc2ZdynsOWQOS03lzWKc&callback=initMap"></script>
{% endblock %}